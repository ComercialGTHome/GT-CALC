<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="GT Home">
    <title>GT Home - Sistema de Corre√ß√£o e Negocia√ß√£o</title>
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23000' width='100' height='100'/><text y='70' font-size='70' fill='%23FF6B00'>GT</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --gt-black: #000000;
            --gt-orange: #FF6B00;
            --gt-orange-dark: #E55F00;
            --gt-orange-light: #FF8533;
            --gt-gray: #1a1a1a;
            --gt-gray-light: #2a2a2a;
            --gt-gray-lighter: #f5f5f5;
            --gt-white: #ffffff;
            --gt-border: #333333;
            --success: #00C853;
            --error: #FF3D00;
            --discount: #FF1744;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gt-black);
            color: var(--gt-white);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--gt-black) 0%, var(--gt-gray) 100%);
            padding: 1.5rem;
            text-align: center;
            border-bottom: 3px solid var(--gt-orange);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: -0.5px;
            margin-bottom: 0.3rem;
        }

        .logo span {
            color: var(--gt-orange);
        }

        .subtitle {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.7;
            font-weight: 500;
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            gap: 1rem;
            max-width: 1400px;
            margin: 1.5rem auto;
            padding: 0 1.5rem;
        }

        .mode-btn {
            flex: 1;
            padding: 1.25rem;
            background: var(--gt-gray);
            border: 3px solid var(--gt-border);
            border-radius: 12px;
            color: var(--gt-white);
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .mode-btn:hover {
            border-color: var(--gt-orange);
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, var(--gt-orange) 0%, var(--gt-orange-dark) 100%);
            border-color: var(--gt-orange);
        }

        .mode-icon {
            font-size: 2rem;
        }

        .mode-description {
            font-size: 0.75rem;
            font-weight: 400;
            opacity: 0.8;
            text-transform: none;
            letter-spacing: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .content-area {
            display: none;
        }

        .content-area.active {
            display: block;
        }

        /* Grid Layout para Modo Proje√ß√£o */
        .projection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 1024px) {
            .projection-grid {
                grid-template-columns: 1fr;
            }
        }

        .section {
            background: var(--gt-gray);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--gt-border);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--gt-orange);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--gt-orange);
            border-radius: 2px;
        }

        /* Toggle Switch R$ / % */
        .input-mode-toggle {
            display: flex;
            background: var(--gt-gray-light);
            border-radius: 8px;
            padding: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .toggle-option {
            flex: 1;
            padding: 0.75rem;
            background: transparent;
            border: none;
            color: var(--gt-white);
            font-weight: 700;
            font-size: 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.6;
        }

        .toggle-option.active {
            background: var(--gt-orange);
            opacity: 1;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--gt-gray-lighter);
        }

        label .required {
            color: var(--gt-orange);
            margin-left: 0.25rem;
        }

        input, select {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid var(--gt-border);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            background: var(--gt-gray-light);
            color: var(--gt-white);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--gt-orange);
            background: var(--gt-gray);
        }

        input.valid {
            border-color: var(--success);
        }

        input.invalid {
            border-color: var(--error);
        }

        input:disabled, input:read-only {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .split-inputs {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 0.75rem;
        }

        .reforco-item {
            background: var(--gt-gray-light);
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid var(--gt-orange);
            margin-bottom: 1rem;
        }

        .reforco-item-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--gt-orange);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .reforco-fields {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 0.75rem;
        }

        .validation-msg {
            margin-top: 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.875rem;
            border-radius: 8px;
            text-align: center;
        }

        .validation-msg.success {
            color: var(--success);
            background: rgba(0, 200, 83, 0.1);
            border: 1px solid var(--success);
        }

        .validation-msg.error {
            color: var(--error);
            background: rgba(255, 61, 0, 0.1);
            border: 1px solid var(--error);
        }

        .btn {
            width: 100%;
            background: linear-gradient(135deg, var(--gt-orange) 0%, var(--gt-orange-dark) 100%);
            color: var(--gt-white);
            border: none;
            padding: 1rem;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 0.75rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 107, 0, 0.4);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--gt-gray-light);
            border: 2px solid var(--gt-orange);
        }

        .btn-secondary:hover {
            background: var(--gt-gray);
        }

        /* Results Section */
        .results-section {
            display: none;
            grid-column: 1 / -1;
        }

        .results-section.active {
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .result-card {
            background: linear-gradient(135deg, var(--gt-gray-light) 0%, var(--gt-gray) 100%);
            padding: 1.25rem;
            border-radius: 8px;
            border-left: 4px solid var(--gt-orange);
        }

        .result-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .result-value {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--gt-orange);
        }

        .result-card.highlight {
            background: linear-gradient(135deg, var(--gt-orange) 0%, var(--gt-orange-dark) 100%);
            border: none;
        }

        .result-card.highlight .result-label,
        .result-card.highlight .result-value {
            color: var(--gt-white);
        }

        /* Negotiation Table */
        .negotiation-table-container {
            overflow-x: auto;
            margin-top: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .negotiation-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--gt-gray-light);
            border-radius: 12px;
            overflow: hidden;
        }

        .negotiation-table thead {
            background: linear-gradient(135deg, var(--gt-orange) 0%, var(--gt-orange-dark) 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .negotiation-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            white-space: nowrap;
            color: var(--gt-white);
        }

        .negotiation-table td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--gt-border);
            font-size: 0.9rem;
        }

        .negotiation-table tbody tr {
            transition: all 0.2s ease;
        }

        .negotiation-table tbody tr:hover {
            background: rgba(255, 107, 0, 0.08);
            transform: scale(1.01);
        }

        .negotiation-table tr.selected {
            background: rgba(255, 107, 0, 0.2);
            border-left: 4px solid var(--gt-orange);
        }

        .negotiation-table tr.selected td {
            font-weight: 600;
        }

        .negotiation-table .checkbox-cell {
            width: 50px;
            text-align: center;
        }

        .negotiation-table input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: var(--gt-orange);
        }

        .negotiation-table .type-badge {
            display: inline-block;
            padding: 0.35rem 0.85rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-badge.parcela {
            background: linear-gradient(135deg, rgba(0, 200, 83, 0.2) 0%, rgba(0, 200, 83, 0.3) 100%);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .type-badge.reforco {
            background: linear-gradient(135deg, rgba(255, 107, 0, 0.2) 0%, rgba(255, 107, 0, 0.3) 100%);
            color: var(--gt-orange);
            border: 1px solid var(--gt-orange);
        }

        .type-badge.chaves {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.3) 100%);
            color: #F57C00;
            border: 1px solid #F57C00;
        }

        /* Discount Summary */
        .discount-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: var(--gt-gray);
            border-radius: 12px;
            border: 2px solid var(--gt-orange);
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 900;
            color: var(--gt-white);
        }

        .summary-value.discount {
            color: var(--discount);
        }

        .summary-value.current {
            color: var(--success);
        }

        .summary-value.projected {
            color: var(--gt-orange);
        }

        /* Indices Collapsible */
        .indices-collapsible {
            background: var(--gt-gray-light);
            border: 2px solid var(--gt-orange);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .indices-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            user-select: none;
        }

        .indices-header::after {
            content: '‚ñº';
            transition: transform 0.3s ease;
        }

        .indices-header.active::after {
            transform: rotate(180deg);
        }

        .indices-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .indices-content.active {
            max-height: 500px;
            padding: 1rem;
            border-top: 1px solid var(--gt-border);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            font-size: 0.75rem;
            opacity: 0.5;
            border-top: 1px solid var(--gt-border);
            margin-top: 3rem;
        }

        /* Print Styles */
        @media print {
            @page {
                margin: 1.5cm;
                size: A4;
            }

            body {
                background: white;
                color: black;
            }

            .header {
                background: #000000 !important;
                color: white !important;
                border-bottom: 5px solid #FF6B00 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                page-break-after: avoid;
                padding: 1.5rem !important;
            }

            .logo {
                font-size: 2.5rem !important;
                font-weight: 900 !important;
            }

            .logo span {
                color: #FF6B00 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .subtitle {
                font-size: 0.9rem !important;
                margin-top: 0.5rem;
            }

            /* Add date and time to print */
            .header::after {
                content: "Gerado em: " attr(data-print-date);
                display: block;
                font-size: 0.75rem;
                margin-top: 0.5rem;
                opacity: 0.8;
            }

            .mode-selector,
            .btn,
            .footer,
            .indices-collapsible,
            #projectionMode .section:not(#resultsProjection):not(#detailedReportProjection),
            #negotiationMode .section:not(#negotiationTableSection),
            .form-group,
            .input-mode-toggle,
            .spinner,
            #unidadeSelect {
                display: none !important;
            }

            .section {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 2px solid #333 !important;
                margin-bottom: 1rem;
                box-shadow: none !important;
            }

            .section-title {
                background: linear-gradient(135deg, #FF6B00 0%, #E55F00 100%) !important;
                color: white !important;
                padding: 0.75rem 1rem !important;
                margin: -1.5rem -1.5rem 1rem -1.5rem !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                border-bottom: 2px solid #000 !important;
                font-size: 1.1rem !important;
            }

            .section-title::before {
                background: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .results-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem !important;
            }

            .result-card {
                border: 2px solid #333 !important;
                background: #f9f9f9 !important;
                break-inside: avoid;
                page-break-inside: avoid;
                padding: 0.75rem !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .result-card.highlight {
                background: #FF6B00 !important;
                border-color: #FF6B00 !important;
                grid-column: 1 / -1 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .result-card.highlight .result-label,
            .result-card.highlight .result-value {
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .result-label {
                color: #666 !important;
                font-size: 0.7rem !important;
            }

            .result-value {
                color: #FF6B00 !important;
                font-size: 1.3rem !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .result-card.highlight .result-value {
                font-size: 1.8rem !important;
            }

            .negotiation-table-container {
                page-break-inside: avoid;
            }

            .negotiation-table {
                border: 2px solid #000 !important;
                font-size: 0.7rem !important;
                width: 100% !important;
            }

            .negotiation-table thead {
                background: linear-gradient(135deg, #FF6B00 0%, #E55F00 100%) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .negotiation-table th {
                color: white !important;
                border: 1px solid #000 !important;
                padding: 0.5rem !important;
                font-size: 0.7rem !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .negotiation-table td {
                border: 1px solid #ddd !important;
                padding: 0.4rem !important;
                font-size: 0.65rem !important;
            }

            .negotiation-table tr.highlight {
                background: #fff3e0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .negotiation-table tr.selected {
                background: #ffe0b2 !important;
                font-weight: 700 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .type-badge {
                padding: 0.15rem 0.4rem !important;
                font-size: 0.6rem !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .type-badge.parcela {
                background: rgba(0, 200, 83, 0.2) !important;
                color: #00C853 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .type-badge.reforco {
                background: rgba(255, 107, 0, 0.2) !important;
                color: #FF6B00 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .type-badge.chaves {
                background: rgba(255, 215, 0, 0.3) !important;
                color: #F57C00 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .discount-summary {
                border: 3px solid #FF6B00 !important;
                background: #fff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                page-break-inside: avoid;
                margin-bottom: 1.5rem !important;
            }

            .summary-item {
                border: 1px solid #eee !important;
                padding: 0.75rem !important;
            }

            .summary-label {
                font-size: 0.75rem !important;
            }

            .summary-value {
                font-size: 1.5rem !important;
            }

            .summary-value.discount {
                color: #FF1744 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .summary-value.current {
                color: #00C853 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .summary-value.projected {
                color: #FF6B00 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .checkbox-cell {
                display: none !important;
            }

            .negotiation-table th:first-child,
            .negotiation-table td:first-child {
                display: none !important;
            }

            /* Print Summary Box */
            .print-summary {
                display: block !important;
                background: #f5f5f5 !important;
                border: 3px solid #333 !important;
                border-left: 8px solid #FF6B00 !important;
                padding: 1.25rem !important;
                margin-bottom: 1.5rem !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                page-break-inside: avoid;
            }

            .print-summary h3 {
                color: #FF6B00 !important;
                margin-bottom: 1rem !important;
                font-size: 1.3rem !important;
                border-bottom: 2px solid #FF6B00 !important;
                padding-bottom: 0.5rem !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .print-summary-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 0.5rem !important;
            }

            .print-summary-item {
                display: flex;
                justify-content: space-between;
                padding: 0.4rem 0;
                border-bottom: 1px solid #ddd;
                font-size: 0.85rem;
            }

            .print-summary-label {
                font-weight: 600;
                color: #333;
            }

            .print-summary-value {
                color: #FF6B00 !important;
                font-weight: 700;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Page break control */
            .results-section {
                page-break-before: avoid;
            }

            #detailedReportProjection {
                page-break-before: always;
            }

            #negotiationTableSection {
                page-break-before: always;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid var(--gt-gray-light);
            border-top: 4px solid var(--gt-orange);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
            display: none;
        }

        .spinner.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .discount-summary {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .negotiation-table {
                font-size: 0.85rem;
            }

            .negotiation-table th,
            .negotiation-table td {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">GT <span>HOME</span></div>
        <div class="subtitle">Sistema de Corre√ß√£o e Negocia√ß√£o</div>
    </div>

    <!-- Mode Selector -->
    <div class="mode-selector">
        <button class="mode-btn active" id="projectionModeBtn">
            <span class="mode-icon">üìä</span>
            <span>Proje√ß√£o de Unidade</span>
            <span class="mode-description">Calcular corre√ß√£o e evolu√ß√£o</span>
        </button>
        <button class="mode-btn" id="negotiationModeBtn">
            <span class="mode-icon">üí∞</span>
            <span>Negocia√ß√£o Cliente</span>
            <span class="mode-description">Simular antecipa√ß√£o e descontos</span>
        </button>
    </div>

    <div class="container">
        <!-- PROJE√á√ÉO DE UNIDADE -->
        <div class="content-area active" id="projectionMode">
            <div class="projection-grid">
                <!-- Configura√ß√£o de √çndices -->
                <div class="section" style="grid-column: 1 / -1;">
                    <div class="indices-collapsible">
                        <div class="indices-header" id="indicesHeader">
                            Configurar √çndices (IPCA e CUB)
                        </div>
                        <div class="indices-content" id="indicesContent">
                            <div class="split-inputs">
                                <div class="form-group">
                                    <label for="ipcaManual">IPCA Atual (%)</label>
                                    <input type="number" id="ipcaManual" step="0.01" value="0.16" inputmode="decimal">
                                </div>
                                <div class="form-group">
                                    <label for="cubManual">CUB Atual (%)</label>
                                    <input type="number" id="cubManual" step="0.01" value="0.34" inputmode="decimal">
                                </div>
                            </div>
                            <div class="split-inputs">
                                <div class="form-group">
                                    <label for="taxaReajuste">Taxa de Reajuste Adicional (%)</label>
                                    <input type="number" id="taxaReajuste" step="0.01" value="0" inputmode="decimal">
                                    <small style="opacity: 0.7; font-size: 0.75rem; display: block; margin-top: 0.3rem;">
                                        Ser√° somada aos √≠ndices selecionados abaixo
                                    </small>
                                </div>
                                <div class="form-group">
                                    <label>Aplicar Taxa Em:</label>
                                    <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; text-transform: none; font-weight: 500;">
                                            <input type="checkbox" id="aplicarTaxaIPCA" checked style="width: auto;">
                                            <span>IPCA</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; text-transform: none; font-weight: 500;">
                                            <input type="checkbox" id="aplicarTaxaCUB" style="width: auto;">
                                            <span>CUB</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <small style="opacity: 0.7; font-size: 0.75rem; display: block; margin-top: 0.5rem;">
                                * Valores negativos ser√£o considerados como 0%
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Modo de Entrada -->
                <div class="section">
                    <h2 class="section-title">Modo de Entrada</h2>
                    
                    <div class="input-mode-toggle">
                        <button class="toggle-option active" id="modeReais">R$</button>
                        <button class="toggle-option" id="modePercent">%</button>
                    </div>

                    <!-- Modo R$ -->
                    <div id="reaisInputs">
                        <div class="form-group">
                            <label for="entradaValor">Entrada (R$)</label>
                            <input type="text" id="entradaValor" placeholder="0,00" class="money-input">
                        </div>

                        <div class="form-group">
                            <label for="parcelaValor">Valor Parcela Mensal (R$)</label>
                            <input type="text" id="parcelaValor" placeholder="0,00" class="money-input">
                        </div>

                        <div class="form-group">
                            <label for="qtdParcelas">Quantidade de Parcelas</label>
                            <input type="number" id="qtdParcelas" placeholder="36" min="1" max="180" value="36" inputmode="numeric">
                        </div>

                        <div class="form-group">
                            <label for="qtdReforcosManual">Quantidade de Refor√ßos</label>
                            <input type="number" id="qtdReforcosManual" placeholder="0" min="0" max="20" value="0" inputmode="numeric">
                        </div>

                        <div id="reforcosIndividuaisContainer"></div>

                        <div class="form-group">
                            <label for="chavesValor">Chaves (R$)</label>
                            <input type="text" id="chavesValor" placeholder="0,00" class="money-input">
                        </div>

                        <div class="result-card" style="margin-top: 1rem;">
                            <div class="result-label">Valor Total Negocia√ß√£o</div>
                            <div class="result-value" id="totalNegociacaoReais">R$ 0,00</div>
                        </div>
                    </div>

                    <!-- Modo % -->
                    <div id="percentInputs" style="display: none;">
                        <div class="form-group">
                            <label for="valorTotalNegociacao">Valor Total da Negocia√ß√£o (R$) <span class="required">*</span></label>
                            <input type="text" id="valorTotalNegociacao" placeholder="0,00" class="money-input">
                        </div>

                        <div class="form-group">
                            <label for="qtdParcelasPercent">Quantidade de Parcelas <span class="required">*</span></label>
                            <input type="number" id="qtdParcelasPercent" placeholder="36" min="1" max="180" value="36" inputmode="numeric">
                        </div>

                        <div class="form-group">
                            <label for="qtdReforcosPercent">Quantidade de Refor√ßos</label>
                            <input type="number" id="qtdReforcosPercent" placeholder="0" min="0" max="20" value="0" inputmode="numeric">
                        </div>

                        <div id="reforcosIndividuaisContainerPercent"></div>

                        <div class="form-group">
                            <label for="entradaPercent">Entrada (%)</label>
                            <input type="number" id="entradaPercent" placeholder="0" min="0" max="100" step="0.01" inputmode="decimal">
                        </div>

                        <div class="form-group">
                            <label for="parcelasPercent">Parcelas (%)</label>
                            <input type="number" id="parcelasPercent" placeholder="0" min="0" max="100" step="0.01" inputmode="decimal">
                        </div>

                        <div class="form-group">
                            <label for="chavesPercent">Chaves (%)</label>
                            <input type="number" id="chavesPercent" placeholder="0" min="0" max="100" step="0.01" inputmode="decimal">
                        </div>

                        <div id="percentValidation" class="validation-msg" style="display: none;"></div>
                    </div>
                </div>

                <!-- Informa√ß√µes do Im√≥vel -->
                <div class="section">
                    <h2 class="section-title">Informa√ß√µes do Im√≥vel</h2>

                    <div class="form-group">
                        <label for="tipoImovel">Tipo de Im√≥vel</label>
                        <select id="tipoImovel">
                            <option value="pronto">Im√≥vel Pronto</option>
                            <option value="obras">Em Obras</option>
                        </select>
                    </div>

                    <div class="form-group" id="dataEntregaGroup" style="display: none;">
                        <label for="dataEntrega">Data de Entrega/Chaves (MM/AA)</label>
                        <input type="text" id="dataEntrega" placeholder="12/26" maxlength="5">
                    </div>

                    <div class="form-group" id="dataChavesGroup">
                        <label for="dataChaves">Data das Chaves (MM/AA)</label>
                        <input type="text" id="dataChaves" placeholder="02/28" maxlength="5">
                    </div>

                    <div class="form-group">
                        <label for="dataInicio">Data de In√≠cio (MM/AA)</label>
                        <input type="text" id="dataInicio" placeholder="02/26" maxlength="5">
                    </div>

                    <button class="btn" id="calcularProjecaoBtn">Calcular Proje√ß√£o</button>
                    <button class="btn btn-secondary" id="limparProjecaoBtn">Limpar</button>
                </div>

                <!-- Resultados Proje√ß√£o -->
                <div class="results-section" id="resultsProjection">
                    <!-- Print Summary (visible only on print) -->
                    <div class="print-summary" style="display: none;" id="printSummary">
                        <h3>Resumo da Proposta</h3>
                        <div class="print-summary-grid" id="printSummaryContent"></div>
                    </div>

                    <div class="section">
                        <h2 class="section-title">Resultados da Proje√ß√£o</h2>
                        <div class="results-grid" id="resultsGridProjection"></div>
                        <button class="btn" id="verDetalhesProjecao">Ver Extrato Completo</button>
                        <button class="btn btn-secondary" id="imprimirProjecao">Imprimir</button>
                    </div>

                    <div class="section" id="detailedReportProjection" style="display: none;">
                        <h2 class="section-title">Extrato Detalhado</h2>
                        <div id="reportContentProjection"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEGOCIA√á√ÉO CLIENTE -->
        <div class="content-area" id="negotiationMode">
            <div class="section">
                <h2 class="section-title">Selecionar Unidade</h2>
                <div class="form-group">
                    <label for="unidadeSelect">Unidade(s) Calculada(s)</label>
                    <select id="unidadeSelect" multiple style="min-height: 120px;">
                        <option value="" disabled>Nenhuma unidade calculada ainda</option>
                    </select>
                    <small style="opacity: 0.7; font-size: 0.75rem; display: block; margin-top: 0.5rem;">
                        * Calcule uma proje√ß√£o primeiro no modo "Proje√ß√£o de Unidade"
                    </small>
                </div>
            </div>

            <div class="section" id="negotiationTableSection" style="display: none;">
                <h2 class="section-title">Simula√ß√£o de Antecipa√ß√£o</h2>
                
                <div class="discount-summary">
                    <div class="summary-item">
                        <div class="summary-label">Valor Atual (Sem Corre√ß√£o)</div>
                        <div class="summary-value current" id="valorAtualSum">R$ 0,00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Valor Projetado (Corrigido)</div>
                        <div class="summary-value projected" id="valorProjetadoSum">R$ 0,00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Desconto ao Antecipar</div>
                        <div class="summary-value discount" id="descontoSum">R$ 0,00</div>
                    </div>
                </div>

                <div class="negotiation-table-container">
                    <table class="negotiation-table">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th>M√™s</th>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Valor Atual</th>
                                <th>Valor Corrigido</th>
                                <th>Desconto</th>
                            </tr>
                        </thead>
                        <tbody id="negotiationTableBody">
                        </tbody>
                    </table>
                </div>

                <button class="btn" id="imprimirNegociacao" style="margin-top: 1.5rem;">Imprimir Simula√ß√£o</button>
            </div>
        </div>

        <div class="spinner" id="spinner"></div>

        <div class="footer">
            GT HOME ¬© 2025 - Todos os direitos reservados
        </div>
    </div>

    <script>
        // Prevenir comportamento padr√£o do iOS
        document.addEventListener('touchstart', function(){}, {passive: true});

        // Dados hist√≥ricos
        const ipcaData = {
            '01/2023': 0.53, '02/2023': 0.84, '03/2023': 0.71, '04/2023': 0.61,
            '05/2023': 0.23, '06/2023': 0.12, '07/2023': 0.12, '08/2023': 0.23,
            '09/2023': 0.26, '10/2023': 0.24, '11/2023': 0.28, '12/2023': 0.56,
            '01/2024': 0.42, '02/2024': 0.83, '03/2024': 0.16, '04/2024': 0.38,
            '05/2024': 0.46, '06/2024': 0.21, '07/2024': 0.38, '08/2024': 0.02,
            '09/2024': 0.44, '10/2024': 0.56, '11/2024': 0.39, '12/2024': 0.52,
            '01/2025': 0.16, '02/2025': 1.31, '03/2025': 0.56, '04/2025': 0.43,
            '05/2025': 0.26, '06/2025': 0.24, '07/2025': 0.26, '08/2025': 0.11,
            '09/2025': 0.48, '10/2025': 0.09, '11/2025': 0.18, '12/2025': 0.33,
            '01/2026': 0.16
        };

        const cubData = {
            '01/2023': 0.28, '02/2023': 0.31, '03/2023': 0.29, '04/2023': 0.27,
            '05/2023': 0.30, '06/2023': 0.32, '07/2023': 0.33, '08/2023': 0.31,
            '09/2023': 0.34, '10/2023': 0.33, '11/2023': 0.30, '12/2023': 0.32,
            '01/2024': 0.30, '02/2024': 0.29, '03/2024': 0.33, '04/2024': 0.30,
            '05/2024': 0.29, '06/2024': 0.31, '07/2024': 0.33, '08/2024': 0.30,
            '09/2024': 0.33, '10/2024': 0.33, '11/2024': 0.30, '12/2024': 0.33,
            '01/2025': 0.31, '02/2025': 0.35, '03/2025': 0.34, '04/2025': 0.34,
            '05/2025': 0.32, '06/2025': 0.33, '07/2025': 0.34, '08/2025': 0.33,
            '09/2025': 0.34, '10/2025': 0.34, '11/2025': 0.33, '12/2025': 0.34,
            '01/2026': 0.34
        };

        let lastPositiveIPCA = 0.56;
        for (let key in ipcaData) {
            if (ipcaData[key] > 0) lastPositiveIPCA = ipcaData[key];
        }

        // Storage para unidades calculadas
        let unidadesCalculadas = [];

        // Fun√ß√µes utilit√°rias
        function formatarMoeda(valor) {
            return valor.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatarInputMoeda(valor) {
            valor = valor.replace(/\D/g, '');
            valor = (parseInt(valor || 0) / 100).toFixed(2);
            valor = valor.replace('.', ',');
            valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
            return valor;
        }

        function parseValorMoeda(valor) {
            if (!valor) return 0;
            return parseFloat(valor.replace(/\./g, '').replace(',', '.')) || 0;
        }

        function getNextMonth(mesAno) {
            const [mes, ano] = mesAno.split('/');
            let mesInt = parseInt(mes);
            let anoInt = parseInt(ano);
            mesInt++;
            if (mesInt > 12) {
                mesInt = 1;
                anoInt++;
            }
            return `${String(mesInt).padStart(2, '0')}/${String(anoInt).padStart(2, '0')}`;
        }

        function compararDatas(data1, data2) {
            const [m1, a1] = data1.split('/').map(Number);
            const [m2, a2] = data2.split('/').map(Number);
            const ano1 = a1 < 50 ? 2000 + a1 : 1900 + a1;
            const ano2 = a2 < 50 ? 2000 + a2 : 1900 + a2;
            if (ano1 !== ano2) return ano1 - ano2;
            return m1 - m2;
        }

        function getIndiceCorrecao(mesAno, tipoImovel, mesEntrega, mesChaves) {
            const taxaReajuste = parseFloat(document.getElementById('taxaReajuste').value) || 0;
            const aplicarTaxaIPCA = document.getElementById('aplicarTaxaIPCA').checked;
            const aplicarTaxaCUB = document.getElementById('aplicarTaxaCUB').checked;
            
            if (mesChaves && compararDatas(mesAno, mesChaves) >= 0) {
                const ipcaManual = parseFloat(document.getElementById('ipcaManual').value) || 0;
                const ipca = ipcaData[mesAno] !== undefined ? ipcaData[mesAno] : Math.max(0, ipcaManual);
                const ipcaFinal = Math.max(ipca > 0 ? ipca : lastPositiveIPCA, 0);
                return aplicarTaxaIPCA ? ipcaFinal + taxaReajuste : ipcaFinal;
            }

            if (tipoImovel === 'obras') {
                if (mesEntrega && compararDatas(mesAno, mesEntrega) <= 0) {
                    const cubManual = parseFloat(document.getElementById('cubManual').value) || 0;
                    const cub = cubData[mesAno] !== undefined ? cubData[mesAno] : Math.max(0, cubManual);
                    const cubFinal = Math.max(0, cub);
                    return aplicarTaxaCUB ? cubFinal + taxaReajuste : cubFinal;
                } else {
                    const ipcaManual = parseFloat(document.getElementById('ipcaManual').value) || 0;
                    const ipca = ipcaData[mesAno] !== undefined ? ipcaData[mesAno] : Math.max(0, ipcaManual);
                    const ipcaFinal = Math.max(ipca > 0 ? ipca : lastPositiveIPCA, 0);
                    return aplicarTaxaIPCA ? ipcaFinal + taxaReajuste : ipcaFinal;
                }
            } else {
                const ipcaManual = parseFloat(document.getElementById('ipcaManual').value) || 0;
                const ipca = ipcaData[mesAno] !== undefined ? ipcaData[mesAno] : Math.max(0, ipcaManual);
                const ipcaFinal = Math.max(ipca > 0 ? ipca : lastPositiveIPCA, 0);
                return aplicarTaxaIPCA ? ipcaFinal + taxaReajuste : ipcaFinal;
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-preencher data de in√≠cio
            const hoje = new Date();
            const proximoMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 1);
            const mm = String(proximoMes.getMonth() + 1).padStart(2, '0');
            const yy = String(proximoMes.getFullYear()).slice(-2);
            document.getElementById('dataInicio').value = `${mm}/${yy}`;

            // Mode Selector
            document.getElementById('projectionModeBtn').addEventListener('click', function() {
                document.getElementById('projectionModeBtn').classList.add('active');
                document.getElementById('negotiationModeBtn').classList.remove('active');
                document.getElementById('projectionMode').classList.add('active');
                document.getElementById('negotiationMode').classList.remove('active');
            });

            document.getElementById('negotiationModeBtn').addEventListener('click', function() {
                document.getElementById('negotiationModeBtn').classList.add('active');
                document.getElementById('projectionModeBtn').classList.remove('active');
                document.getElementById('negotiationMode').classList.add('active');
                document.getElementById('projectionMode').classList.remove('active');
            });

            // Toggle √çndices
            document.getElementById('indicesHeader').addEventListener('click', function() {
                this.classList.toggle('active');
                document.getElementById('indicesContent').classList.toggle('active');
            });

            // Toggle R$ / %
            document.getElementById('modeReais').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('modePercent').classList.remove('active');
                document.getElementById('reaisInputs').style.display = 'block';
                document.getElementById('percentInputs').style.display = 'none';
            });

            document.getElementById('modePercent').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('modeReais').classList.remove('active');
                document.getElementById('percentInputs').style.display = 'block';
                document.getElementById('reaisInputs').style.display = 'none';
            });

            // Tipo de im√≥vel
            document.getElementById('tipoImovel').addEventListener('change', function() {
                const isObras = this.value === 'obras';
                document.getElementById('dataEntregaGroup').style.display = isObras ? 'block' : 'none';
                document.getElementById('dataChavesGroup').style.display = isObras ? 'none' : 'block';
            });

            // Formata√ß√£o de moeda
            document.querySelectorAll('.money-input').forEach(input => {
                input.addEventListener('input', function(e) {
                    e.target.value = formatarInputMoeda(e.target.value);
                    if (document.getElementById('modeReais').classList.contains('active')) {
                        calcularTotalNegociacaoReais();
                    }
                });

                input.addEventListener('blur', function(e) {
                    if (!e.target.value) e.target.value = '0,00';
                });

                input.addEventListener('focus', function(e) {
                    if (e.target.value === '0,00') e.target.value = '';
                });
            });

            // Formata√ß√£o de data MM/AA
            document.querySelectorAll('input[maxlength="5"]').forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.slice(0, 2) + '/' + value.slice(2, 4);
                    }
                    e.target.value = value;
                });
            });

            // Atualizar qtd refor√ßos
            document.getElementById('qtdParcelas').addEventListener('change', calcularTotalNegociacaoReais);

            // Criar campos de refor√ßos individuais
            document.getElementById('qtdReforcosManual').addEventListener('input', function() {
                criarCamposReforcosIndividuais(this.value, 'reais');
            });

            document.getElementById('qtdReforcosPercent').addEventListener('input', function() {
                criarCamposReforcosIndividuais(this.value, 'percent');
            });

            // Valida√ß√£o de porcentagens
            ['entradaPercent', 'parcelasPercent', 'chavesPercent'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', validarPorcentagens);
                }
            });

            // Bot√µes
            const calcularProjecaoBtn = document.getElementById('calcularProjecaoBtn');
            if (calcularProjecaoBtn) {
                calcularProjecaoBtn.addEventListener('click', calcularProjecao);
            }
            
            const limparProjecaoBtn = document.getElementById('limparProjecaoBtn');
            if (limparProjecaoBtn) {
                limparProjecaoBtn.addEventListener('click', limparProjecao);
            }
            
            const verDetalhesProjecao = document.getElementById('verDetalhesProjecao');
            if (verDetalhesProjecao) {
                verDetalhesProjecao.addEventListener('click', mostrarDetalhesProjecao);
            }
            
            const imprimirProjecao = document.getElementById('imprimirProjecao');
            if (imprimirProjecao) {
                imprimirProjecao.addEventListener('click', imprimirExtrato);
            }
            
            const imprimirNegociacao = document.getElementById('imprimirNegociacao');
            if (imprimirNegociacao) {
                imprimirNegociacao.addEventListener('click', imprimirExtrato);
            }

            // Select all checkbox
            document.getElementById('selectAll').addEventListener('change', function() {
                document.querySelectorAll('.negotiation-table tbody input[type="checkbox"]').forEach(cb => {
                    cb.checked = this.checked;
                });
                calcularDescontoTotal();
            });

            // Sele√ß√£o de unidade
            document.getElementById('unidadeSelect').addEventListener('change', carregarUnidadeNegociacao);
        });

        // Criar campos individuais de refor√ßos
        function criarCamposReforcosIndividuais(quantidade, modo) {
            const qtd = parseInt(quantidade) || 0;
            const containerId = modo === 'reais' ? 'reforcosIndividuaisContainer' : 'reforcosIndividuaisContainerPercent';
            const container = document.getElementById(containerId);
            
            container.innerHTML = '';
            
            for (let i = 1; i <= qtd; i++) {
                const div = document.createElement('div');
                div.className = 'reforco-item';
                
                if (modo === 'reais') {
                    div.innerHTML = `
                        <div class="reforco-item-title">Refor√ßo ${i}</div>
                        <div class="reforco-fields">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="reforco${i}Valor">Valor (R$)</label>
                                <input type="text" id="reforco${i}Valor" placeholder="0,00" class="money-input reforco-valor-input">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="reforco${i}Data">Data (MM/AA)</label>
                                <input type="text" id="reforco${i}Data" placeholder="06/26" maxlength="5" class="reforco-data-input">
                            </div>
                        </div>
                    `;
                } else {
                    div.innerHTML = `
                        <div class="reforco-item-title">Refor√ßo ${i}</div>
                        <div class="reforco-fields">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="reforcoPercent${i}Valor">Porcentagem (%)</label>
                                <input type="number" id="reforcoPercent${i}Valor" placeholder="0" min="0" max="100" step="0.01" inputmode="decimal" class="reforco-percent-input">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="reforcoPercent${i}Data">Data (MM/AA)</label>
                                <input type="text" id="reforcoPercent${i}Data" placeholder="06/26" maxlength="5" class="reforco-data-input">
                            </div>
                        </div>
                    `;
                }
                
                container.appendChild(div);
            }
            
            // Adicionar formata√ß√£o de moeda aos novos inputs
            container.querySelectorAll('.money-input').forEach(input => {
                input.addEventListener('input', function(e) {
                    e.target.value = formatarInputMoeda(e.target.value);
                    calcularTotalNegociacaoReais();
                });
                input.addEventListener('blur', function(e) {
                    if (!e.target.value) e.target.value = '0,00';
                });
                input.addEventListener('focus', function(e) {
                    if (e.target.value === '0,00') e.target.value = '';
                });
            });
            
            // Adicionar formata√ß√£o de data aos novos inputs
            container.querySelectorAll('.reforco-data-input').forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.slice(0, 2) + '/' + value.slice(2, 4);
                    }
                    e.target.value = value;
                });
            });
            
            // Adicionar event listener para porcentagens
            container.querySelectorAll('.reforco-percent-input').forEach(input => {
                input.addEventListener('input', validarPorcentagens);
            });
            
            if (modo === 'reais') {
                calcularTotalNegociacaoReais();
            } else {
                validarPorcentagens();
            }
        }

        // Calcular total no modo R$
        function calcularTotalNegociacaoReais() {
            const entrada = parseValorMoeda(document.getElementById('entradaValor').value);
            const parcela = parseValorMoeda(document.getElementById('parcelaValor').value);
            const qtdParcelas = parseInt(document.getElementById('qtdParcelas').value) || 0;
            const chaves = parseValorMoeda(document.getElementById('chavesValor').value);

            const totalParcelas = parcela * qtdParcelas;
            
            // Somar todos os refor√ßos individuais
            let totalReforcos = 0;
            const qtdReforcos = parseInt(document.getElementById('qtdReforcosManual').value) || 0;
            for (let i = 1; i <= qtdReforcos; i++) {
                const reforcoInput = document.getElementById(`reforco${i}Valor`);
                if (reforcoInput) {
                    totalReforcos += parseValorMoeda(reforcoInput.value);
                }
            }

            const total = entrada + totalParcelas + totalReforcos + chaves;
            document.getElementById('totalNegociacaoReais').textContent = `R$ ${formatarMoeda(total)}`;
        }

        // Validar porcentagens
        function validarPorcentagens() {
            const entrada = parseFloat(document.getElementById('entradaPercent').value) || 0;
            const parcelas = parseFloat(document.getElementById('parcelasPercent').value) || 0;
            const chaves = parseFloat(document.getElementById('chavesPercent').value) || 0;
            
            // Somar todos os refor√ßos individuais
            let totalReforcosPercent = 0;
            const qtdReforcos = parseInt(document.getElementById('qtdReforcosPercent').value) || 0;
            for (let i = 1; i <= qtdReforcos; i++) {
                const reforcoInput = document.getElementById(`reforcoPercent${i}Valor`);
                if (reforcoInput) {
                    totalReforcosPercent += parseFloat(reforcoInput.value) || 0;
                }
            }

            const total = entrada + parcelas + totalReforcosPercent + chaves;
            const msgDiv = document.getElementById('percentValidation');

            if (total === 0) {
                msgDiv.style.display = 'none';
                return false;
            }

            if (Math.abs(total - 100) < 0.01) {
                msgDiv.textContent = `‚úì Total: ${total.toFixed(2)}% - Validado!`;
                msgDiv.className = 'validation-msg success';
                msgDiv.style.display = 'block';
                return true;
            } else {
                msgDiv.textContent = `‚úó Total: ${total.toFixed(2)}% - Deve ser 100%`;
                msgDiv.className = 'validation-msg error';
                msgDiv.style.display = 'block';
                return false;
            }
        }

        // Calcular proje√ß√£o
        function calcularProjecao() {
            try {
                console.log('=== INICIANDO C√ÅLCULO ===');
                const modoReais = document.getElementById('modeReais').classList.contains('active');
                console.log('Modo:', modoReais ? 'R$' : '%');
                
                let entrada, valorParcela, qtdParcelas, chaves, reforcosIndividuais = [];

            if (modoReais) {
                console.log('Modo R$ selecionado');
                entrada = parseValorMoeda(document.getElementById('entradaValor').value);
                valorParcela = parseValorMoeda(document.getElementById('parcelaValor').value);
                qtdParcelas = parseInt(document.getElementById('qtdParcelas').value) || 0;
                chaves = parseValorMoeda(document.getElementById('chavesValor').value);
                
                console.log('Valores:', {entrada, valorParcela, qtdParcelas, chaves});
                
                // Coletar refor√ßos individuais
                const qtdReforcos = parseInt(document.getElementById('qtdReforcosManual').value) || 0;
                console.log('Quantidade de refor√ßos:', qtdReforcos);
                
                for (let i = 1; i <= qtdReforcos; i++) {
                    const valorInput = document.getElementById(`reforco${i}Valor`);
                    const dataInput = document.getElementById(`reforco${i}Data`);
                    if (valorInput && dataInput && dataInput.value) {
                        reforcosIndividuais.push({
                            numero: i,
                            valor: parseValorMoeda(valorInput.value),
                            data: dataInput.value
                        });
                    }
                }
                console.log('Refor√ßos coletados:', reforcosIndividuais);
            } else {
                if (!validarPorcentagens()) {
                    alert('A soma das porcentagens deve ser 100%');
                    return;
                }

                const valorTotal = parseValorMoeda(document.getElementById('valorTotalNegociacao').value);
                if (valorTotal === 0) {
                    alert('Informe o valor total da negocia√ß√£o');
                    return;
                }

                qtdParcelas = parseInt(document.getElementById('qtdParcelasPercent').value) || 0;

                const percEntrada = parseFloat(document.getElementById('entradaPercent').value) || 0;
                const percParcelas = parseFloat(document.getElementById('parcelasPercent').value) || 0;
                const percChaves = parseFloat(document.getElementById('chavesPercent').value) || 0;

                entrada = (valorTotal * percEntrada / 100);
                const totalParcelas = (valorTotal * percParcelas / 100);
                valorParcela = qtdParcelas > 0 ? totalParcelas / qtdParcelas : 0;
                chaves = (valorTotal * percChaves / 100);
                
                // Coletar refor√ßos individuais do modo percent
                const qtdReforcos = parseInt(document.getElementById('qtdReforcosPercent').value) || 0;
                for (let i = 1; i <= qtdReforcos; i++) {
                    const percentInput = document.getElementById(`reforcoPercent${i}Valor`);
                    const dataInput = document.getElementById(`reforcoPercent${i}Data`);
                    if (percentInput && dataInput && dataInput.value) {
                        const percReforco = parseFloat(percentInput.value) || 0;
                        reforcosIndividuais.push({
                            numero: i,
                            valor: (valorTotal * percReforco / 100),
                            data: dataInput.value
                        });
                    }
                }
            }

            const tipoImovel = document.getElementById('tipoImovel').value;
            const dataInicio = document.getElementById('dataInicio').value;
            const dataEntrega = document.getElementById('dataEntrega').value;
            
            // Se em obras, usa dataEntrega como dataChaves. Se pronto, usa dataChaves
            const dataChaves = tipoImovel === 'obras' ? dataEntrega : document.getElementById('dataChaves').value;

            console.log('Dados do im√≥vel:', {tipoImovel, dataInicio, dataEntrega, dataChaves, qtdParcelas});

            if (!dataInicio || qtdParcelas === 0) {
                console.error('Valida√ß√£o falhou:', {dataInicio, qtdParcelas});
                alert('Preencha os campos obrigat√≥rios');
                return;
            }

            console.log('Valida√ß√£o OK, iniciando spinner...');
            document.getElementById('spinner').classList.add('active');

            console.log('Iniciando setTimeout para c√°lculos...');
            setTimeout(() => {
                console.log('Dentro do setTimeout, iniciando c√°lculos de parcelas...');
                let mesAtual = dataInicio;
                let parcelas = [];
                let reforcos = [];

                for (let mes = 1; mes <= qtdParcelas; mes++) {
                    let valorCorrigido = valorParcela;
                    let mesCalculo = dataInicio;
                    
                    for (let m = 1; m <= mes; m++) {
                        const indice = getIndiceCorrecao(mesCalculo, tipoImovel, dataEntrega, dataChaves);
                        valorCorrigido *= (1 + indice / 100);
                        mesCalculo = getNextMonth(mesCalculo);
                    }

                    parcelas.push({
                        mes: mes,
                        mesAno: mesAtual,
                        tipo: 'parcela',
                        valorOriginal: valorParcela,
                        valorCorrigido: valorCorrigido
                    });

                    mesAtual = getNextMonth(mesAtual);
                }

                // Processar refor√ßos individuais com suas datas espec√≠ficas
                reforcosIndividuais.forEach(reforcoConfig => {
                    let valorReforcoCorrigido = reforcoConfig.valor;
                    let mesCalculo = dataInicio;
                    
                    // Calcular corre√ß√£o at√© a data do refor√ßo
                    while (compararDatas(mesCalculo, reforcoConfig.data) < 0) {
                        const indice = getIndiceCorrecao(mesCalculo, tipoImovel, dataEntrega, dataChaves);
                        valorReforcoCorrigido *= (1 + indice / 100);
                        mesCalculo = getNextMonth(mesCalculo);
                    }

                    reforcos.push({
                        numero: reforcoConfig.numero,
                        mesAno: reforcoConfig.data,
                        tipo: 'reforco',
                        valorOriginal: reforcoConfig.valor,
                        valorCorrigido: valorReforcoCorrigido
                    });
                });

                let chavesCorrigido = chaves;
                if (dataChaves) {
                    let mesCalculo = dataInicio;
                    while (compararDatas(mesCalculo, dataChaves) < 0) {
                        const indice = getIndiceCorrecao(mesCalculo, tipoImovel, dataEntrega, dataChaves);
                        chavesCorrigido *= (1 + indice / 100);
                        mesCalculo = getNextMonth(mesCalculo);
                    }
                }

                const totalParcelasCorrigido = parcelas.reduce((sum, p) => sum + p.valorCorrigido, 0);
                const totalReforcosCorrigido = reforcos.reduce((sum, r) => sum + r.valorCorrigido, 0);
                const totalAtualizado = entrada + totalParcelasCorrigido + totalReforcosCorrigido + chavesCorrigido;

                // Exibir resultados
                let html = `
                    <div class="result-card">
                        <div class="result-label">Primeira Parcela</div>
                        <div class="result-value">R$ ${formatarMoeda(parcelas[0].valorCorrigido)}</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">√öltima Parcela</div>
                        <div class="result-value">R$ ${formatarMoeda(parcelas[parcelas.length - 1].valorCorrigido)}</div>
                    </div>
                `;

                if (reforcos.length > 0) {
                    html += `
                        <div class="result-card">
                            <div class="result-label">Primeiro Refor√ßo</div>
                            <div class="result-value">R$ ${formatarMoeda(reforcos[0].valorCorrigido)}</div>
                        </div>
                        <div class="result-card">
                            <div class="result-label">√öltimo Refor√ßo</div>
                            <div class="result-value">R$ ${formatarMoeda(reforcos[reforcos.length - 1].valorCorrigido)}</div>
                        </div>
                    `;
                }

                html += `
                    <div class="result-card">
                        <div class="result-label">Chaves (${dataChaves || 'Final'})</div>
                        <div class="result-value">R$ ${formatarMoeda(chavesCorrigido)}</div>
                    </div>
                    <div class="result-card highlight">
                        <div class="result-label">Valor Total Atualizado</div>
                        <div class="result-value">R$ ${formatarMoeda(totalAtualizado)}</div>
                    </div>
                `;

                document.getElementById('resultsGridProjection').innerHTML = html;
                document.getElementById('resultsProjection').classList.add('active');

                // Gerar resumo para impress√£o
                const modoTexto = modoReais ? 'Valores em R$' : 'Valores em %';
                const tipoImovelTexto = tipoImovel === 'obras' ? 'Em Obras' : 'Im√≥vel Pronto';
                
                const totalReforcosOriginal = reforcosIndividuais.reduce((sum, r) => sum + r.valor, 0);
                
                const printSummaryHTML = `
                    <div class="print-summary-item">
                        <span class="print-summary-label">Modo de Entrada:</span>
                        <span class="print-summary-value">${modoTexto}</span>
                    </div>
                    <div class="print-summary-item">
                        <span class="print-summary-label">Tipo de Im√≥vel:</span>
                        <span class="print-summary-value">${tipoImovelTexto}</span>
                    </div>
                    <div class="print-summary-item">
                        <span class="print-summary-label">Data de In√≠cio:</span>
                        <span class="print-summary-value">${dataInicio}</span>
                    </div>
                    <div class="print-summary-item">
                        <span class="print-summary-label">Prazo:</span>
                        <span class="print-summary-value">${qtdParcelas} meses</span>
                    </div>
                    <div class="print-summary-item">
                        <span class="print-summary-label">Entrada:</span>
                        <span class="print-summary-value">R$ ${formatarMoeda(entrada)}</span>
                    </div>
                    <div class="print-summary-item">
                        <span class="print-summary-label">Parcelas (${qtdParcelas}x):</span>
                        <span class="print-summary-value">R$ ${formatarMoeda(valorParcela)}</span>
                    </div>
                    <div class="print-summary-item">
                        <span class="print-summary-label">Refor√ßos (${reforcosIndividuais.length}):</span>
                        <span class="print-summary-value">R$ ${formatarMoeda(totalReforcosOriginal)}</span>
                    </div>
                    <div class="print-summary-item">
                        <span class="print-summary-label">Chaves:</span>
                        <span class="print-summary-value">R$ ${formatarMoeda(chaves)}</span>
                    </div>
                    <div class="print-summary-item" style="border-top: 2px solid #FF6B00; margin-top: 0.5rem; padding-top: 0.5rem;">
                        <span class="print-summary-label" style="font-size: 1.1rem;">Valor Total Proposta:</span>
                        <span class="print-summary-value" style="font-size: 1.3rem;">R$ ${formatarMoeda(entrada + (valorParcela * qtdParcelas) + totalReforcosOriginal + chaves)}</span>
                    </div>
                    <div class="print-summary-item" style="border-top: 2px solid #FF6B00;">
                        <span class="print-summary-label" style="font-size: 1.1rem;">Valor Total Atualizado:</span>
                        <span class="print-summary-value" style="font-size: 1.3rem;">R$ ${formatarMoeda(totalAtualizado)}</span>
                    </div>
                `;
                
                document.getElementById('printSummaryContent').innerHTML = printSummaryHTML;

                // Salvar unidade calculada
                const unidadeNome = `Unidade ${unidadesCalculadas.length + 1} - ${new Date().toLocaleString('pt-BR')}`;
                
                // Criar lista combinada de todos os itens
                let todosItens = [];
                
                // Adicionar entrada
                todosItens.push({
                    ordem: 0,
                    mes: 0,
                    mesAno: dataInicio,
                    tipo: 'entrada',
                    valorOriginal: entrada,
                    valorCorrigido: entrada
                });
                
                // Adicionar parcelas
                parcelas.forEach(p => {
                    todosItens.push({
                        ordem: p.mes,
                        mes: p.mes,
                        mesAno: p.mesAno,
                        tipo: 'parcela',
                        valorOriginal: p.valorOriginal,
                        valorCorrigido: p.valorCorrigido
                    });
                });
                
                // Adicionar refor√ßos (j√° com suas datas espec√≠ficas)
                reforcos.forEach(r => {
                    // Encontrar o m√™s correspondente √† data do refor√ßo
                    const parcelaNaData = parcelas.find(p => p.mesAno === r.mesAno);
                    const mesOrdem = parcelaNaData ? parcelaNaData.mes : 999; // Se n√£o encontrar parcela, p√µe no final
                    
                    todosItens.push({
                        ordem: mesOrdem,
                        mes: mesOrdem,
                        mesAno: r.mesAno,
                        tipo: 'reforco',
                        numero: r.numero,
                        valorOriginal: r.valorOriginal,
                        valorCorrigido: r.valorCorrigido
                    });
                });
                
                // Adicionar chaves (na posi√ß√£o correta por data)
                if (chaves > 0 && dataChaves) {
                    const parcelaNaDataChaves = parcelas.find(p => p.mesAno === dataChaves);
                    const mesOrdem = parcelaNaDataChaves ? parcelaNaDataChaves.mes : parcelas.length + 1;
                    
                    todosItens.push({
                        ordem: mesOrdem,
                        mes: mesOrdem,
                        mesAno: dataChaves,
                        tipo: 'chaves',
                        valorOriginal: chaves,
                        valorCorrigido: chavesCorrigido
                    });
                }
                
                // Ordenar todos os itens por ordem e tipo
                todosItens.sort((a, b) => {
                    if (a.ordem !== b.ordem) return a.ordem - b.ordem;
                    const tipoOrdem = { entrada: 0, parcela: 1, reforco: 2, chaves: 3 };
                    return tipoOrdem[a.tipo] - tipoOrdem[b.tipo];
                });

                const unidade = {
                    nome: unidadeNome,
                    itens: todosItens,
                    totalOriginal: entrada + (valorParcela * qtdParcelas) + totalReforcosOriginal + chaves,
                    totalCorrigido: totalAtualizado
                };

                unidadesCalculadas.push(unidade);
                atualizarSelectUnidades();

                window.dadosCalculoAtual = unidade;

                document.getElementById('spinner').classList.remove('active');
                document.getElementById('resultsProjection').scrollIntoView({ behavior: 'smooth' });
            }, 300);
            } catch (error) {
                console.error('Erro no c√°lculo:', error);
                alert('Erro ao calcular: ' + error.message);
                document.getElementById('spinner').classList.remove('active');
            }
        }

        // Atualizar select de unidades
        function atualizarSelectUnidades() {
            const select = document.getElementById('unidadeSelect');
            select.innerHTML = '';
            
            if (unidadesCalculadas.length === 0) {
                select.innerHTML = '<option value="" disabled>Nenhuma unidade calculada ainda</option>';
                return;
            }

            unidadesCalculadas.forEach((unidade, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = unidade.nome;
                select.appendChild(option);
            });
        }

        // Carregar unidade para negocia√ß√£o
        function carregarUnidadeNegociacao() {
            const select = document.getElementById('unidadeSelect');
            const selectedOptions = Array.from(select.selectedOptions);
            
            if (selectedOptions.length === 0) return;

            const unidadesSelecionadas = selectedOptions.map(opt => unidadesCalculadas[opt.value]);
            
            // Combinar todas as unidades selecionadas
            let todosItens = [];
            
            unidadesSelecionadas.forEach(unidade => {
                todosItens.push(...unidade.itens);
            });

            // Ordenar por ordem e tipo
            todosItens.sort((a, b) => {
                if (a.ordem !== b.ordem) return a.ordem - b.ordem;
                const tipoOrdem = { entrada: 0, parcela: 1, reforco: 2, chaves: 3 };
                return tipoOrdem[a.tipo] - tipoOrdem[b.tipo];
            });

            // Renderizar tabela
            const tbody = document.getElementById('negotiationTableBody');
            tbody.innerHTML = '';

            todosItens.forEach((item, index) => {
                const desconto = item.valorCorrigido - item.valorOriginal;
                const tr = document.createElement('tr');
                
                let tipoLabel = '';
                let tipoBadge = '';
                if (item.tipo === 'entrada') {
                    tipoLabel = 'Entrada';
                    tipoBadge = 'parcela';
                } else if (item.tipo === 'parcela') {
                    tipoLabel = 'Parcela';
                    tipoBadge = 'parcela';
                } else if (item.tipo === 'reforco') {
                    tipoLabel = `Refor√ßo ${item.numero}`;
                    tipoBadge = 'reforco';
                } else if (item.tipo === 'chaves') {
                    tipoLabel = 'Chaves';
                    tipoBadge = 'chaves';
                }

                tr.innerHTML = `
                    <td class="checkbox-cell">
                        <input type="checkbox" class="item-checkbox" data-index="${index}" 
                               data-original="${item.valorOriginal}" 
                               data-corrigido="${item.valorCorrigido}">
                    </td>
                    <td>${item.mes === 0 ? '0' : item.mes}</td>
                    <td>${item.mesAno}</td>
                    <td><span class="type-badge ${tipoBadge}">${tipoLabel}</span></td>
                    <td>R$ ${formatarMoeda(item.valorOriginal)}</td>
                    <td>R$ ${formatarMoeda(item.valorCorrigido)}</td>
                    <td style="color: var(--discount); font-weight: 700;">R$ ${formatarMoeda(desconto)}</td>
                `;

                tbody.appendChild(tr);
            });

            // Add event listeners aos checkboxes
            document.querySelectorAll('.item-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    this.closest('tr').classList.toggle('selected', this.checked);
                    calcularDescontoTotal();
                });
            });

            document.getElementById('negotiationTableSection').style.display = 'block';
            calcularDescontoTotal();
        }

        // Calcular desconto total
        function calcularDescontoTotal() {
            let totalOriginal = 0;
            let totalCorrigido = 0;

            document.querySelectorAll('.item-checkbox:checked').forEach(cb => {
                totalOriginal += parseFloat(cb.dataset.original);
                totalCorrigido += parseFloat(cb.dataset.corrigido);
            });

            const desconto = totalCorrigido - totalOriginal;

            document.getElementById('valorAtualSum').textContent = `R$ ${formatarMoeda(totalOriginal)}`;
            document.getElementById('valorProjetadoSum').textContent = `R$ ${formatarMoeda(totalCorrigido)}`;
            document.getElementById('descontoSum').textContent = `R$ ${formatarMoeda(desconto)}`;
        }

        // Mostrar detalhes
        function mostrarDetalhesProjecao() {
            if (!window.dadosCalculoAtual) return;

            const unidade = window.dadosCalculoAtual;
            let html = '<h3 style="margin-bottom: 1rem; color: var(--gt-orange);">Extrato M√™s a M√™s</h3>';
            html += '<table class="negotiation-table"><thead><tr><th>M√™s</th><th>Data</th><th>Tipo</th><th>Valor Original</th><th>Valor Corrigido</th></tr></thead><tbody>';

            unidade.itens.forEach(item => {
                let tipoLabel = '';
                let classe = '';
                
                if (item.tipo === 'entrada') {
                    tipoLabel = 'Entrada';
                    classe = 'highlight';
                } else if (item.tipo === 'parcela') {
                    tipoLabel = 'Parcela';
                } else if (item.tipo === 'reforco') {
                    tipoLabel = `Refor√ßo ${item.numero}`;
                    classe = 'highlight';
                } else if (item.tipo === 'chaves') {
                    tipoLabel = 'Chaves';
                    classe = 'highlight';
                }
                
                html += `<tr class="${classe}"><td>${item.mes === 0 ? '0' : item.mes}</td><td>${item.mesAno}</td><td>${tipoLabel}</td><td>R$ ${formatarMoeda(item.valorOriginal)}</td><td>R$ ${formatarMoeda(item.valorCorrigido)}</td></tr>`;
            });

            html += '</tbody></table>';

            document.getElementById('reportContentProjection').innerHTML = html;
            document.getElementById('detailedReportProjection').style.display = 'block';
            document.getElementById('detailedReportProjection').scrollIntoView({ behavior: 'smooth' });
        }

        // Limpar
        function imprimirExtrato() {
            // Adicionar data e hora √† impress√£o
            const agora = new Date();
            const dataHora = agora.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.querySelector('.header').setAttribute('data-print-date', dataHora);
            
            window.print();
        }

        function limparProjecao() {
            document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
                if (input.id !== 'dataInicio' && input.id !== 'qtdParcelas' && input.id !== 'qtdParcelasPercent' &&
                    input.id !== 'ipcaManual' && input.id !== 'cubManual' && 
                    input.id !== 'qtdReforcosManual' && input.id !== 'qtdReforcosPercent') {
                    if (input.classList.contains('money-input')) {
                        input.value = '0,00';
                    } else if (input.type === 'number') {
                        input.value = '';
                    } else {
                        input.value = '';
                    }
                }
            });

            // Limpar quantidade de refor√ßos e containers
            document.getElementById('qtdReforcosManual').value = '0';
            document.getElementById('qtdReforcosPercent').value = '0';
            document.getElementById('reforcosIndividuaisContainer').innerHTML = '';
            document.getElementById('reforcosIndividuaisContainerPercent').innerHTML = '';

            document.getElementById('resultsProjection').classList.remove('active');
            document.getElementById('detailedReportProjection').style.display = 'none';
            document.getElementById('percentValidation').style.display = 'none';
            document.getElementById('totalNegociacaoReais').textContent = 'R$ 0,00';
        }
    </script>
</body>
</html>
